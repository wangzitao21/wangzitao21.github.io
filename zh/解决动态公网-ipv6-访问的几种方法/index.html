<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>解决动态公网 IPv6 访问的几种方法 | 汪子涛的个人博客</title><meta name=keywords content="Network,Linux"><meta name=description content="之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。
但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。"><meta name=author content="汪子涛"><link rel=canonical href=https://wangzitao21.github.io/zh/%E8%A7%A3%E5%86%B3%E5%8A%A8%E6%80%81%E5%85%AC%E7%BD%91-ipv6-%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/><script type=text/javascript async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://wangzitao21.github.io/favicon/favicon16x16.gif><link rel=icon type=image/png sizes=16x16 href=https://wangzitao21.github.io/favicon/favicon16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wangzitao21.github.io/favicon/favicon32x32.png><link rel=apple-touch-icon href=https://wangzitao21.github.io/favicon/favicon180x180.png><link rel=mask-icon href=https://wangzitao21.github.io/favicon/favicon180x180.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wangzitao21.github.io/en/methods-to-access-dynamic-public-ipv6/><link rel=alternate hreflang=zh href=https://wangzitao21.github.io/zh/%E8%A7%A3%E5%86%B3%E5%8A%A8%E6%80%81%E5%85%AC%E7%BD%91-ipv6-%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wangzitao21.github.io/zh/%E8%A7%A3%E5%86%B3%E5%8A%A8%E6%80%81%E5%85%AC%E7%BD%91-ipv6-%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"><meta property="og:site_name" content="汪子涛的个人博客"><meta property="og:title" content="解决动态公网 IPv6 访问的几种方法"><meta property="og:description" content="之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。
但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。"><meta property="og:locale" content="zh-CN"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-01-26T00:00:00+00:00"><meta property="article:modified_time" content="2025-01-26T00:00:00+00:00"><meta property="article:tag" content="Network"><meta property="article:tag" content="Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="解决动态公网 IPv6 访问的几种方法"><meta name=twitter:description content="之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。
但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wangzitao21.github.io/zh/post/"},{"@type":"ListItem","position":2,"name":"解决动态公网 IPv6 访问的几种方法","item":"https://wangzitao21.github.io/zh/%E8%A7%A3%E5%86%B3%E5%8A%A8%E6%80%81%E5%85%AC%E7%BD%91-ipv6-%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"解决动态公网 IPv6 访问的几种方法","name":"解决动态公网 IPv6 访问的几种方法","description":"之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。\n但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。\n","keywords":["Network","Linux"],"articleBody":"之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。\n但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。\n以下是我尝试的几种应对措施。\nDDNS 解决动态 IP 的最好办法就是使用 DDNS，即动态 DNS 解析。以下是具体的流程。\n1 配置反向代理 首先需要安装 Nginx，并用 acme 申请域名证书。这里最好申请泛域名证书，以便使用多个三级域名。具体步骤见 [[Nginx (反向代理) 和 Acme (证书配置)]]，本文不再赘述。\n然后配置 Nginx 反向代理，步骤如下:\n以 Anki 服务为例，该服务监听 27701 端口。创建配置文件: 1 2 cd /etc/nginx/conf.d \u0026\u0026 \\ vim /etc/nginx/conf.d/anki.conf 写入以下配置。端口号的范围是 0-65535，这里我将只监听 63001 这样的高位端口，只采用 SSL 访问。HTTP 不设置监听。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 server { listen 63001 ssl; listen [::]:63001 ssl; server_name anki.example.com; location / { proxy_pass http://127.0.0.1:27701; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_redirect off; proxy_set_header X-Real-Port $remote_port; proxy_set_header HTTP_X_FORWARDED_FOR $remote_addr; proxy_set_header X-NginX-Proxy true; proxy_set_header Accept-Encoding \"\"; } ssl_certificate /root/.acme.sh/example.com_ecc/fullchain.cer; ssl_certificate_key /root/.acme.sh/example.com_ecc/example.com.key; add_header Strict-Transport-Security \"max-age=63072000\" always; } 这样做的话，在某些设备上可能无法从 HTTP 重定向到 HTTPS，需要在域名前面手动输入 https://。\n另外，需要记得在防火墙放行 63001 端口。\n2 安装与配置 DDNS-GO 我使用 ddns-go 项目搭建，Docker 命令如下:\n1 2 3 4 5 6 docker run -d \\ --name ddns-go \\ --restart=always \\ --net=host \\ -v /home/wang/docker_data/ddns-go:/root \\ jeessy2/ddns-go 容器构建完成后，在 9876 端口就可以直接访问 ddns-go 的 Web 界面，并进行以下配置:\nDNS 服务商选择 Cloudflare。 打开 Cloudflare 首页，依次找到“管理账户” \u003e “账号 API 令牌” \u003e “创建令牌” \u003e “编辑区域 DNS”，点击“使用模板”，然后选中自己的二级域名作为需要包括的区域。 复制生成的 Token 值，并粘贴到 DDNS-GO 的 Web 界面里。 继续在 Web 界面，勾选启用 IPv6，选择“通过网口获取”，选中对应网口，在 Domains 处填写自己需要动态解析的三级域名，然后保存上述配置即可。 在命令行尝试查询自己的三级域名 IP: 1 nslookup xxx.example.com 3 关于 DDNS 的风险 由于 DDNS 需要配置域名，并且要在域名厂商处配置 DNS 解析。原则上，建站就必须在工信部备案。\n但备案又不能使用家用设备。另外，据网上所说，运营商有时候会检测并查封 TLS 入站流量。所以使用 DDNS 可能会面临一定风险。\n规避这种风险的措施有以下几种:\n改用高位端口。常用的 80、443、8080、8443 等端口都尽量不要使用 (有的地区这些端口默认就是关闭的)。 添加域名的访问路径。比如 xxx.example.com 可以改成只有 xxx.example.com/path 才能访问，没有输入路径则返回 444 报错。 放弃公网访问，改用 VPN。使用 VPN 访问无疑是最安全的，但是这种方式一般仅限自己个人使用，分享给别人会麻烦一些。下文的 Tailscale 部分将介绍这种做法。 手动 DDNS。配置一个 SMTP 邮件服务器，定时向邮箱发送服务器当前的 IPv6。这是最粗暴的一种做法，可作为备用手段。下文将介绍这种做法。 使用 Tailscale VPN Tailscale 是一款基于 WireGuard 协议的虚拟局域网搭建工具，可以将不同地方的设备连接到一个私有的网络中。\nTailscale 的最大优势就是在两端设备都有公网 IPv6 的情况下，可以直连而不需要第三方服务器中转，因此访问速度能得到保障。\nTailscale 的安装基本没有什么难度，直接在 Download 页面正常下载，并完成安装注册流程即可。\n在所有设备都安装 Tailscale 后，可在 Admin console 页面查询到虚拟局域网内所有在线和不在线的设备。此后我们只要保证 Tailscale 后台开启，就能使用局域网域名或 IP 直接访问对应服务。\nLinux 系统可以使用以下命令查询和关闭/启用 Tailscale:\n1 2 3 4 5 6 sudo systemctl enable tailscaled sudo systemctl status tailscaled sudo systemctl restart tailscaled sudo systemctl stop tailscaled cat /lib/systemd/system/tailscaled.service Tailscale 的用法还有很多，对于我而言，目前只需要达到 VPN 访问的目的。后续有需要将持续更新。\n1 中转服务器 对于没有 IPv6 的设备，Tailscale 支持使用中转服务器。但是 Tailscale 提供的中转服务器都在国外，延迟难以得到保障。我们可以使用以下命令查询官方中转服务器延迟:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 # 测试中转服务器延迟 tailscale netcheck # 输出如下 Report: * Time: 2025-01-26T10:37:16.276723386Z * UDP: true * IPv4: yes, xxx.xxx.xxx.xxx:26667 * IPv6: yes, [240e:xxxx:xxxx:xxxx::c2]:57110 * MappingVariesByDestIP: false * PortMapping: * CaptivePortal: false * Nearest DERP: Tokyo * DERP latency: - tok: 130.7ms (Tokyo) - sin: 159ms (Singapore) - sfo: 160.1ms (San Francisco) - hkg: 166.8ms (Hong Kong) - lax: 167.9ms (Los Angeles) - sea: 168.2ms (Seattle) - den: 172.6ms (Denver) - ... ... 为了提高无公网 IPv6 设备的使用体验，我们也可以搭建一个中转服务器。但对于我目前的处境而言，完全没有这方面的需求，因此未作尝试。\n2 文件共享 Tailscale 只需要在 General 界面 开启“Send Files”功能，就可以在虚拟局域网内各个在线设备间传输文件。\nWindows 和 Android 系统会发送到系统的 Downloads 文件夹，Linux 系统会发送到以下目录:\n1 /var/lib/tailscale/files/账号邮箱-uid-xxxxxx 不过目前感觉该功能还是略显鸡肋，Android 每次还得专门开启 Tailscale 后才能传输。而 Windows 和 Linux 间虽然可以默认自启，但完全可以事先挂载各种共享文件夹。\n邮件定时发送 IPv6 地址 为了防止 DDNS 方法失效，我还准备了一个最粗暴的方法，即用 Python 写一个简单的脚本，定时用我的 Foxmail 邮箱向我的 Outlook 邮箱报告当前服务器的 IPv6 地址，以备在特殊情况下可以采用纯 IP 访问。\n具体步骤如下:\n首先在 Foxmail 中配置 SMTP/IMAP 服务，按照官网指示操作即可。 执行以下命令创建 Conda 环境和安装相关模块: 1 2 3 conda create -n ddns python=3.11 \u0026\u0026 conda activate ddns pip install requests schedule 我这里编写了一个简单的 Python 脚本:\n1 vim /home/wang/shell/ddns_mail.py 写入以下内容:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 import smtplib from email.mime.text import MIMEText import requests import schedule import time # 邮箱配置 SMTP_SERVER = 'smtp.qq.com' # SMTP 服务器地址 SMTP_PORT = 587 # SMTP 服务器端口号 EMAIL_ADDRESS = 'xxx@foxmail.com' # 发送邮箱地址 EMAIL_PASSWORD = \"xxx\" # 邮箱应用专用密码 RECEIVER_EMAIL = 'xxx@outlook.com' # 收件邮箱地址 # 获取 IPv6 地址的 API (可根据需要更换, 或从本地直接获取) IPV6_API = 'https://api6.ipify.org' def get_ipv6_address(): \"\"\"获取服务器的 IPv6 地址。\"\"\" try: response = requests.get(IPV6_API) response.raise_for_status() # 检查请求是否成功 return response.text.strip() except requests.exceptions.RequestException as e: print(f\"获取 IPv6 地址失败: {e}\") return None def send_email(ipv6_address): \"\"\"发送包含 IPv6 地址的邮件。\"\"\" if ipv6_address: message = MIMEText(f\"服务器当前的 IPv6 地址是: {ipv6_address}\") message['Subject'] = '服务器 IPv6 地址' message['From'] = EMAIL_ADDRESS message['To'] = RECEIVER_EMAIL server = None try: server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT) server.starttls() # 启用 TLS 加密 server.login(EMAIL_ADDRESS, EMAIL_PASSWORD) server.sendmail(EMAIL_ADDRESS, RECEIVER_EMAIL, message.as_string()) print(\"邮件发送成功！\") except Exception as e: # 捕获更广泛的异常 print(f\"邮件发送失败: ({type(e)}) {e}\") # 输出异常的类型 finally: if server: try: server.quit() except Exception as e: print(f\"关闭连接时出现错误: ({type(e)}) {e}\") else: print(\"无法发送邮件，IPv6 地址未知。\") def job(): \"\"\"定时任务函数，获取并发送 IPv6 地址。\"\"\" ipv6_address = get_ipv6_address() send_email(ipv6_address) # 设置定时任务 schedule.every().day.at(\"20:17\").do(job) if __name__ == \"__main__\": print(\"脚本已启动，将每天定时发送 IPv6 地址。\") while True: schedule.run_pending() time.sleep(1) 为上述脚本添加一个守护进程: 1 sudo vim /etc/systemd/system/ddns_mail.service 写入以下内容:\n1 2 3 4 5 6 7 8 9 10 11 12 13 [Unit] Description=DDNS Mail After=network.target [Service] Type=simple User=wang WorkingDirectory=/home/wang/shell ExecStart=/home/wang/apps/miniconda3/envs/ddns/bin/python /home/wang/shell/ddns_mail.py \u003e\u003e /home/wang/logs/ddns_mail.log 2\u003e\u00261 Restart=on-failure [Install] WantedBy=multi-user.target 启用或关闭进程服务。 1 2 3 4 5 6 sudo systemctl daemon-reload sudo systemctl enable ddns_mail.service sudo systemctl restart ddns_mail.service sudo systemctl status ddns_mail.service # 查询日志 journalctl -u ddns_mail.service 上述脚本目前能正常运行，但输出日志一直是空的，手动执行和权限问题都排查了也没能解决。具体原因暂时不想深究了，能正常使用就行。\n","wordCount":"2729","inLanguage":"zh","datePublished":"2025-01-26T00:00:00Z","dateModified":"2025-01-26T00:00:00Z","author":{"@type":"Person","name":"汪子涛"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wangzitao21.github.io/zh/%E8%A7%A3%E5%86%B3%E5%8A%A8%E6%80%81%E5%85%AC%E7%BD%91-ipv6-%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/"},"publisher":{"@type":"Organization","name":"汪子涛的个人博客","logo":{"@type":"ImageObject","url":"https://wangzitao21.github.io/favicon/favicon16x16.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wangzitao21.github.io/zh/ accesskey=h title="个人博客 (Alt + H)">个人博客</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://wangzitao21.github.io/en/ title="🌐 Switch to English" aria-label="🌐 Switch to English">🌐 Switch to English</a></li></ul></div></div><ul id=menu><li><a href=https://wangzitao21.github.io/zh/ title=🏠主页><span>🏠主页</span></a></li><li><a href=https://wangzitao21.github.io/zh/search title="🔎搜索 (Alt + /)" accesskey=/><span>🔎搜索</span></a></li><li><a href=https://wangzitao21.github.io/zh/archives title=📚归档><span>📚归档</span></a></li><li><a href=https://wangzitao21.github.io/zh/tags title=🧩️分类><span>🧩️分类</span></a></li><li><a href=https://wangzitao21.github.io/zh/about title=👤关于><span>👤关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wangzitao21.github.io/zh/>主页</a>&nbsp;»&nbsp;<a href=https://wangzitao21.github.io/zh/post/>Posts</a></div><h1 class="post-title entry-hint-parent">解决动态公网 IPv6 访问的几种方法</h1><div class=post-meta><span title='2025-01-26 00:00:00 +0000 UTC'>2025/1/26</span>&nbsp;·&nbsp;汪子涛&nbsp;|&nbsp;语言:<ul class=i18n_list><li><a href=https://wangzitao21.github.io/en/methods-to-access-dynamic-public-ipv6/>🌐 Switch to English</a></li></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#ddns aria-label=DDNS>DDNS</a><ul><li><a href=#1-%e9%85%8d%e7%bd%ae%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86 aria-label="1 配置反向代理">1 配置反向代理</a></li><li><a href=#2-%e5%ae%89%e8%a3%85%e4%b8%8e%e9%85%8d%e7%bd%ae-ddns-go aria-label="2 安装与配置 DDNS-GO">2 安装与配置 DDNS-GO</a></li><li><a href=#3-%e5%85%b3%e4%ba%8e-ddns-%e7%9a%84%e9%a3%8e%e9%99%a9 aria-label="3 关于 DDNS 的风险">3 关于 DDNS 的风险</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8-tailscale-vpn aria-label="使用 Tailscale VPN">使用 Tailscale VPN</a><ul><li><a href=#1-%e4%b8%ad%e8%bd%ac%e6%9c%8d%e5%8a%a1%e5%99%a8 aria-label="1 中转服务器">1 中转服务器</a></li><li><a href=#2-%e6%96%87%e4%bb%b6%e5%85%b1%e4%ba%ab aria-label="2 文件共享">2 文件共享</a></li></ul></li><li><a href=#%e9%82%ae%e4%bb%b6%e5%ae%9a%e6%97%b6%e5%8f%91%e9%80%81-ipv6-%e5%9c%b0%e5%9d%80 aria-label="邮件定时发送 IPv6 地址">邮件定时发送 IPv6 地址</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>之前将家里的光猫设置为桥接模式，改用路由器拨号并关闭 IPv6 防火墙，能够顺利使用公网 IPv6 入站。</p><p>但运营商提供的是 /56 位的动态 IPv6 前缀，每隔几天就会更换一次，使用起来不是很方便。</p><p>以下是我尝试的几种应对措施。</p><h1 id=ddns>DDNS<a hidden class=anchor aria-hidden=true href=#ddns>#</a></h1><p>解决动态 IP 的最好办法就是使用 DDNS，即动态 DNS 解析。以下是具体的流程。</p><h2 id=1-配置反向代理>1 配置反向代理<a hidden class=anchor aria-hidden=true href=#1-配置反向代理>#</a></h2><p>首先需要安装 Nginx，并用 acme 申请域名证书。这里最好申请泛域名证书，以便使用多个三级域名。具体步骤见 [[Nginx (反向代理) 和 Acme (证书配置)]]，本文不再赘述。</p><p>然后配置 Nginx 反向代理，步骤如下:</p><ol><li>以 Anki 服务为例，该服务监听 27701 端口。创建配置文件:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> /etc/nginx/conf.d <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>vim /etc/nginx/conf.d/anki.conf
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>写入以下配置。端口号的范围是 0-65535，这里我将只监听 63001 这样的高位端口，只采用 SSL 访问。HTTP 不设置监听。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>63001</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:63001</span> <span class=s>ssl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>anki.example.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:27701</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-Proto</span> <span class=nv>$scheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_redirect</span> <span class=no>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-Real-Port</span> <span class=nv>$remote_port</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>HTTP_X_FORWARDED_FOR</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>X-NginX-Proxy</span> <span class=s>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Accept-Encoding</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate</span> <span class=s>/root/.acme.sh/example.com_ecc/fullchain.cer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span> <span class=s>/root/.acme.sh/example.com_ecc/example.com.key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>add_header</span> <span class=s>Strict-Transport-Security</span> <span class=s>&#34;max-age=63072000&#34;</span> <span class=s>always</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>这样做的话，在某些设备上可能无法从 HTTP 重定向到 HTTPS，需要在域名前面手动输入 <code>https://</code>。</p><p>另外，需要记得在防火墙放行 63001 端口。</p></blockquote><h2 id=2-安装与配置-ddns-go>2 安装与配置 DDNS-GO<a hidden class=anchor aria-hidden=true href=#2-安装与配置-ddns-go>#</a></h2><p>我使用 <a href=https://github.com/jeessy2/ddns-go>ddns-go</a> 项目搭建，Docker 命令如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run -d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name ddns-go <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --restart<span class=o>=</span>always <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --net<span class=o>=</span>host <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v /home/wang/docker_data/ddns-go:/root <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  jeessy2/ddns-go
</span></span></code></pre></td></tr></table></div></div><p>容器构建完成后，在 9876 端口就可以直接访问 ddns-go 的 Web 界面，并进行以下配置:</p><ol><li>DNS 服务商选择 Cloudflare。</li><li>打开 <a href=https://dash.cloudflare.com>Cloudflare 首页</a>，依次找到“管理账户” > “账号 API 令牌” > “创建令牌” > “编辑区域 DNS”，点击“使用模板”，然后选中自己的二级域名作为需要包括的区域。</li><li>复制生成的 Token 值，并粘贴到 DDNS-GO 的 Web 界面里。</li><li>继续在 Web 界面，勾选启用 IPv6，选择“通过网口获取”，选中对应网口，在 Domains 处填写自己需要动态解析的三级域名，然后保存上述配置即可。</li><li>在命令行尝试查询自己的三级域名 IP:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nslookup xxx.example.com
</span></span></code></pre></td></tr></table></div></div><h2 id=3-关于-ddns-的风险>3 关于 DDNS 的风险<a hidden class=anchor aria-hidden=true href=#3-关于-ddns-的风险>#</a></h2><p>由于 DDNS 需要配置域名，并且要在域名厂商处配置 DNS 解析。原则上，建站就必须在工信部备案。</p><p>但备案又不能使用家用设备。另外，据网上所说，运营商有时候会检测并查封 TLS 入站流量。所以使用 DDNS 可能会面临一定风险。</p><p>规避这种风险的措施有以下几种:</p><ol><li>改用高位端口。常用的 80、443、8080、8443 等端口都尽量不要使用 (有的地区这些端口默认就是关闭的)。</li><li>添加域名的访问路径。比如 <code>xxx.example.com</code> 可以改成只有 <code>xxx.example.com/path</code> 才能访问，没有输入路径则返回 444 报错。</li><li>放弃公网访问，改用 VPN。使用 VPN 访问无疑是最安全的，但是这种方式一般仅限自己个人使用，分享给别人会麻烦一些。下文的 Tailscale 部分将介绍这种做法。</li><li>手动 DDNS。配置一个 SMTP 邮件服务器，定时向邮箱发送服务器当前的 IPv6。这是最粗暴的一种做法，可作为备用手段。下文将介绍这种做法。</li></ol><h1 id=使用-tailscale-vpn>使用 Tailscale VPN<a hidden class=anchor aria-hidden=true href=#使用-tailscale-vpn>#</a></h1><p><a href=https://tailscale.com/>Tailscale</a> 是一款基于 WireGuard 协议的虚拟局域网搭建工具，可以将不同地方的设备连接到一个私有的网络中。</p><p>Tailscale 的最大优势就是在两端设备都有公网 IPv6 的情况下，可以直连而不需要第三方服务器中转，因此访问速度能得到保障。</p><p>Tailscale 的安装基本没有什么难度，直接在 <a href=https://tailscale.com/download/windows>Download</a> 页面正常下载，并完成安装注册流程即可。</p><p>在所有设备都安装 Tailscale 后，可在 <a href=https://login.tailscale.com/admin/machines>Admin console</a> 页面查询到虚拟局域网内所有在线和不在线的设备。此后我们只要保证 Tailscale 后台开启，就能使用局域网域名或 IP 直接访问对应服务。</p><p>Linux 系统可以使用以下命令查询和关闭/启用 Tailscale:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> tailscaled
</span></span><span class=line><span class=cl>sudo systemctl status tailscaled
</span></span><span class=line><span class=cl>sudo systemctl restart tailscaled
</span></span><span class=line><span class=cl>sudo systemctl stop tailscaled
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /lib/systemd/system/tailscaled.service
</span></span></code></pre></td></tr></table></div></div><p>Tailscale 的用法还有很多，对于我而言，目前只需要达到 VPN 访问的目的。后续有需要将持续更新。</p><h2 id=1-中转服务器>1 中转服务器<a hidden class=anchor aria-hidden=true href=#1-中转服务器>#</a></h2><p>对于没有 IPv6 的设备，Tailscale 支持使用中转服务器。但是 Tailscale 提供的中转服务器都在国外，延迟难以得到保障。我们可以使用以下命令查询官方中转服务器延迟:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 测试中转服务器延迟</span>
</span></span><span class=line><span class=cl>tailscale netcheck
</span></span><span class=line><span class=cl><span class=c1># 输出如下</span>
</span></span><span class=line><span class=cl>Report:
</span></span><span class=line><span class=cl>        * Time: 2025-01-26T10:37:16.276723386Z
</span></span><span class=line><span class=cl>        * UDP: <span class=nb>true</span>
</span></span><span class=line><span class=cl>        * IPv4: yes, xxx.xxx.xxx.xxx:26667
</span></span><span class=line><span class=cl>        * IPv6: yes, <span class=o>[</span>240e:xxxx:xxxx:xxxx::c2<span class=o>]</span>:57110
</span></span><span class=line><span class=cl>        * MappingVariesByDestIP: <span class=nb>false</span>
</span></span><span class=line><span class=cl>        * PortMapping:
</span></span><span class=line><span class=cl>        * CaptivePortal: <span class=nb>false</span>
</span></span><span class=line><span class=cl>        * Nearest DERP: Tokyo
</span></span><span class=line><span class=cl>        * DERP latency:
</span></span><span class=line><span class=cl>                - tok: 130.7ms <span class=o>(</span>Tokyo<span class=o>)</span>
</span></span><span class=line><span class=cl>                - sin: 159ms   <span class=o>(</span>Singapore<span class=o>)</span>
</span></span><span class=line><span class=cl>                - sfo: 160.1ms <span class=o>(</span>San Francisco<span class=o>)</span>
</span></span><span class=line><span class=cl>                - hkg: 166.8ms <span class=o>(</span>Hong Kong<span class=o>)</span>
</span></span><span class=line><span class=cl>                - lax: 167.9ms <span class=o>(</span>Los Angeles<span class=o>)</span>
</span></span><span class=line><span class=cl>                - sea: 168.2ms <span class=o>(</span>Seattle<span class=o>)</span>
</span></span><span class=line><span class=cl>                - den: 172.6ms <span class=o>(</span>Denver<span class=o>)</span>
</span></span><span class=line><span class=cl>                - ... ...
</span></span></code></pre></td></tr></table></div></div><p>为了提高无公网 IPv6 设备的使用体验，我们也可以搭建一个中转服务器。但对于我目前的处境而言，完全没有这方面的需求，因此未作尝试。</p><h2 id=2-文件共享>2 文件共享<a hidden class=anchor aria-hidden=true href=#2-文件共享>#</a></h2><p>Tailscale 只需要在 <a href=https://login.tailscale.com/admin/settings/general>General 界面</a> 开启“Send Files”功能，就可以在虚拟局域网内各个在线设备间传输文件。</p><p>Windows 和 Android 系统会发送到系统的 <code>Downloads</code> 文件夹，Linux 系统会发送到以下目录:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/var/lib/tailscale/files/账号邮箱-uid-xxxxxx
</span></span></code></pre></td></tr></table></div></div><p>不过目前感觉该功能还是略显鸡肋，Android 每次还得专门开启 Tailscale 后才能传输。而 Windows 和 Linux 间虽然可以默认自启，但完全可以事先挂载各种共享文件夹。</p><h1 id=邮件定时发送-ipv6-地址>邮件定时发送 IPv6 地址<a hidden class=anchor aria-hidden=true href=#邮件定时发送-ipv6-地址>#</a></h1><p>为了防止 DDNS 方法失效，我还准备了一个最粗暴的方法，即用 Python 写一个简单的脚本，定时用我的 Foxmail 邮箱向我的 Outlook 邮箱报告当前服务器的 IPv6 地址，以备在特殊情况下可以采用纯 IP 访问。</p><p>具体步骤如下:</p><ol><li>首先在 Foxmail 中配置 <a href="https://wx.mail.qq.com/list/readtemplate?name=app_intro.html#/agreement/authorizationCode">SMTP/IMAP 服务</a>，按照官网指示操作即可。</li><li>执行以下命令创建 Conda 环境和安装相关模块:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>conda create -n ddns <span class=nv>python</span><span class=o>=</span>3.11 <span class=o>&amp;&amp;</span> conda activate ddns
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pip install requests schedule
</span></span></code></pre></td></tr></table></div></div><p>我这里编写了一个简单的 Python 脚本:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>vim /home/wang/shell/ddns_mail.py
</span></span></code></pre></td></tr></table></div></div><p>写入以下内容:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>smtplib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>email.mime.text</span> <span class=kn>import</span> <span class=n>MIMEText</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>schedule</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 邮箱配置</span>
</span></span><span class=line><span class=cl><span class=n>SMTP_SERVER</span> <span class=o>=</span> <span class=s1>&#39;smtp.qq.com&#39;</span>  <span class=c1># SMTP 服务器地址</span>
</span></span><span class=line><span class=cl><span class=n>SMTP_PORT</span> <span class=o>=</span> <span class=mi>587</span>  <span class=c1># SMTP 服务器端口号</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_ADDRESS</span> <span class=o>=</span> <span class=s1>&#39;xxx@foxmail.com&#39;</span> <span class=c1># 发送邮箱地址</span>
</span></span><span class=line><span class=cl><span class=n>EMAIL_PASSWORD</span> <span class=o>=</span> <span class=s2>&#34;xxx&#34;</span> <span class=c1># 邮箱应用专用密码</span>
</span></span><span class=line><span class=cl><span class=n>RECEIVER_EMAIL</span> <span class=o>=</span> <span class=s1>&#39;xxx@outlook.com&#39;</span> <span class=c1># 收件邮箱地址</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取 IPv6 地址的 API (可根据需要更换, 或从本地直接获取)</span>
</span></span><span class=line><span class=cl><span class=n>IPV6_API</span> <span class=o>=</span> <span class=s1>&#39;https://api6.ipify.org&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_ipv6_address</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;&#34;&#34;获取服务器的 IPv6 地址。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>IPV6_API</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>  <span class=c1># 检查请求是否成功</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;获取 IPv6 地址失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_email</span><span class=p>(</span><span class=n>ipv6_address</span><span class=p>):</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;&#34;&#34;发送包含 IPv6 地址的邮件。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>ipv6_address</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span> <span class=o>=</span> <span class=n>MIMEText</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;服务器当前的 IPv6 地址是: </span><span class=si>{</span><span class=n>ipv6_address</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>[</span><span class=s1>&#39;Subject&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;服务器 IPv6 地址&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>[</span><span class=s1>&#39;From&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>EMAIL_ADDRESS</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>[</span><span class=s1>&#39;To&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>RECEIVER_EMAIL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>server</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>server</span> <span class=o>=</span> <span class=n>smtplib</span><span class=o>.</span><span class=n>SMTP</span><span class=p>(</span><span class=n>SMTP_SERVER</span><span class=p>,</span> <span class=n>SMTP_PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>server</span><span class=o>.</span><span class=n>starttls</span><span class=p>()</span>  <span class=c1># 启用 TLS 加密</span>
</span></span><span class=line><span class=cl>      <span class=n>server</span><span class=o>.</span><span class=n>login</span><span class=p>(</span><span class=n>EMAIL_ADDRESS</span><span class=p>,</span> <span class=n>EMAIL_PASSWORD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>server</span><span class=o>.</span><span class=n>sendmail</span><span class=p>(</span><span class=n>EMAIL_ADDRESS</span><span class=p>,</span> <span class=n>RECEIVER_EMAIL</span><span class=p>,</span> <span class=n>message</span><span class=o>.</span><span class=n>as_string</span><span class=p>())</span>
</span></span><span class=line><span class=cl>      <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;邮件发送成功！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span> <span class=c1># 捕获更广泛的异常</span>
</span></span><span class=line><span class=cl>      <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;邮件发送失败: (</span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>) </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=c1># 输出异常的类型</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>server</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>               <span class=n>server</span><span class=o>.</span><span class=n>quit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>               <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;关闭连接时出现错误: (</span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>) </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;无法发送邮件，IPv6 地址未知。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>job</span><span class=p>():</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;&#34;&#34;定时任务函数，获取并发送 IPv6 地址。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=n>ipv6_address</span> <span class=o>=</span> <span class=n>get_ipv6_address</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>send_email</span><span class=p>(</span><span class=n>ipv6_address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置定时任务</span>
</span></span><span class=line><span class=cl><span class=n>schedule</span><span class=o>.</span><span class=n>every</span><span class=p>()</span><span class=o>.</span><span class=n>day</span><span class=o>.</span><span class=n>at</span><span class=p>(</span><span class=s2>&#34;20:17&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>do</span><span class=p>(</span><span class=n>job</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;脚本已启动，将每天定时发送 IPv6 地址。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>schedule</span><span class=o>.</span><span class=n>run_pending</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>为上述脚本添加一个守护进程:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo vim /etc/systemd/system/ddns_mail.service
</span></span></code></pre></td></tr></table></div></div><p>写入以下内容:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=line><span class=cl><span class=k>[Unit]</span>
</span></span><span class=line><span class=cl><span class=na>Description</span><span class=o>=</span><span class=s>DDNS Mail</span>
</span></span><span class=line><span class=cl><span class=na>After</span><span class=o>=</span><span class=s>network.target</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Service]</span>
</span></span><span class=line><span class=cl><span class=na>Type</span><span class=o>=</span><span class=s>simple</span>
</span></span><span class=line><span class=cl><span class=na>User</span><span class=o>=</span><span class=s>wang</span>
</span></span><span class=line><span class=cl><span class=na>WorkingDirectory</span><span class=o>=</span><span class=s>/home/wang/shell</span>
</span></span><span class=line><span class=cl><span class=na>ExecStart</span><span class=o>=</span><span class=s>/home/wang/apps/miniconda3/envs/ddns/bin/python /home/wang/shell/ddns_mail.py &gt;&gt; /home/wang/logs/ddns_mail.log 2&gt;&amp;1</span>
</span></span><span class=line><span class=cl><span class=na>Restart</span><span class=o>=</span><span class=s>on-failure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>[Install]</span>
</span></span><span class=line><span class=cl><span class=na>WantedBy</span><span class=o>=</span><span class=s>multi-user.target</span>
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>启用或关闭进程服务。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> ddns_mail.service
</span></span><span class=line><span class=cl>sudo systemctl restart ddns_mail.service
</span></span><span class=line><span class=cl>sudo systemctl status ddns_mail.service
</span></span><span class=line><span class=cl><span class=c1># 查询日志</span>
</span></span><span class=line><span class=cl>journalctl -u ddns_mail.service
</span></span></code></pre></td></tr></table></div></div><blockquote><p>上述脚本目前能正常运行，但输出日志一直是空的，手动执行和权限问题都排查了也没能解决。具体原因暂时不想深究了，能正常使用就行。</p></blockquote></div><footer class=post-footer><ul class=post-tags><li><a href=https://wangzitao21.github.io/zh/tags/network/>Network</a></li><li><a href=https://wangzitao21.github.io/zh/tags/linux/>Linux</a></li></ul><nav class=paginav><a class=next href=https://wangzitao21.github.io/zh/ssh-%E5%8D%8F%E8%AE%AE%E5%8E%9F%E7%90%86%E5%8F%8A%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B/><span class=title>下一页 »</span><br><span>SSH 协议原理及访问流程</span></a></nav></footer><script src=https://giscus.app/client.js data-repo=wangzitao21/wangzitao21.github.io data-repo-id=R_kgDONoUNzQ data-category=Announcements data-category-id=DIC_kwDONoUNzc4Cl6-6 data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>